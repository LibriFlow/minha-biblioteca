<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Biblioteca Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Configura√ß√µes para Web App em iOS (PWA Lite) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Minha Biblioteca">
    <!-- √çcone para a tela inicial do iOS (substitua pela URL da sua imagem de livro 192x192px) -->
    <link rel="apple-touch-icon" href="https://example.com/images/book_icon_192.png">
    <!-- Exemplo de splash screen para iPhone X/XS/11 Pro (opcional, adicione mais para outros dispositivos) -->
    <link rel="apple-touch-startup-image" href="https://example.com/images/splash_screen_iphonex.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">

    <!-- Favicon padr√£o para navegadores (substitua pela URL da sua imagem de livro 32x32px ou 64x64px) -->
    <link rel="icon" href="https://example.com/images/favicon_32.png" type="image/png">

    <style>
        /* Estilos para o modo escuro */
        body.dark {
            background-color: #1a202c; /* gray-900 */
            color: #e2e8f0; /* gray-200 */
        }
        .dark .bg-gray-50 {
            background-color: #1a202c;
        }
        .dark .bg-white {
            background-color: #2d3748; /* gray-800 */
        }
        .dark .text-gray-800 {
            color: #e2e8f0;
        }
        .dark .text-gray-700 {
            color: #cbd5e0; /* gray-300 */
        }
        .dark .text-gray-600 {
            color: #a0aec0; /* gray-400 */
        }
        .dark .text-gray-500 {
            color: #718096; /* gray-500 */
        }
        .dark .border {
            border-color: #4a5568; /* gray-600 */
        }
        .dark .form-container {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }
        .dark .book-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .dark .book-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .dark .modal-content {
            background-color: #2d3748;
        }
        .dark .login-card {
            background-color: #2d3748;
        }
        .dark .login-card h2, .dark .login-card p {
            color: #e2e8f0;
        }
        .dark .input-error {
            border-color: #f56565; /* red-400 */
            box-shadow: 0 0 0 2px rgba(245, 101, 101, 0.5);
        }
        .dark .error-message {
            color: #f56565; /* red-400 */
        }
        .dark .bg-gray-200 {
            background-color: #4a5568;
        }
        .dark .hover\:bg-gray-300:hover {
            background-color: #616e7f;
        }
        .dark .bg-gray-100 {
            background-color: #2d3748;
        }
        .dark .hover\:bg-gray-100:hover {
            background-color: #4a5568;
        }
        .dark .bg-white.bg-opacity-80 {
            background-color: rgba(45, 55, 72, 0.8);
        }
        .dark .hover\:bg-red-100:hover {
            background-color: #4a2a2a;
        }
        .dark .hover\:bg-blue-100:hover {
            background-color: #2a3a4a;
        }
        .dark .text-yellow-400 {
            color: #f6e05e; /* yellow-300 */
        }
        .dark .text-gray-300 {
            color: #a0aec0; /* gray-400 */
        }
        .dark .text-gray-400 {
            color: #718096; /* gray-500 */
        }
        .dark .text-gray-900 {
            color: #e2e8f0;
        }
        .dark .text-gray-200 {
            color: #a0aec0;
        }
        .dark .text-gray-300 {
            color: #a0aec0;
        }
        .dark .text-gray-400 {
            color: #718096;
        }
        .dark .text-gray-500 {
            color: #718096;
        }
        .dark .text-gray-600 {
            color: #a0aec0;
        }
        .dark .text-gray-700 {
            color: #cbd5e0;
        }
        .dark .text-gray-800 {
            color: #e2e8f0;
        }
        .dark .text-gray-900 {
            color: #e2e8f0;
        }
        .dark .placeholder-gray-500::placeholder {
            color: #a0aec0;
        }
        .dark input, .dark textarea, .dark select {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .dark input:focus, .dark textarea:focus, .dark select:focus {
            border-color: #667eea; /* indigo-400 */
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        .dark .star-rating label {
            color: #4a5568; /* gray-600 */
        }
        .dark .star-rating input:checked ~ label,
        .dark .star-rating input:hover ~ label {
            color: #f6e05e; /* yellow-300 */
        }
        .dark .star-rating label:hover,
        .dark .star-rating label:hover ~ label {
            color: #f6e05e; /* yellow-300 */
        }


        .star-rating {
            display: inline-flex;
            flex-direction: row-reverse; /* CORRE√á√ÉO: Inverte a dire√ß√£o para que o CSS ~ label funcione da esquerda para a direita visualmente */
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            color: #e4e5e9;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .star-rating input:checked ~ label,
        .star-rating input:hover ~ label {
            color: #ffc107;
        }
        /* CORRE√á√ÉO: Ajusta o hover para colorir apenas a estrela atual e as anteriores */
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }
        .book-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 0;
            flex: 1;
            display: flex;
            min-height: 280px;
            position: relative; /* Necess√°rio para o bot√£o de exclus√£o */
        }

        @media (max-width: 640px) {
            .book-card {
                min-height: 220px;
            }
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .form-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .library-container {
            min-height: calc(100vh - 300px);
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Estilos para notifica√ß√µes e modais */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .animate-fade-in { animation: fadeIn 0.3s forwards; }
        .animate-fade-out { animation: fadeOut 0.3s forwards; }

        /* Estilos para anima√ß√£o de exclus√£o do card */
        @keyframes shrinkAndFade {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
        .animate-shrink-fade {
            animation: shrinkAndFade 0.3s forwards;
        }

        /* Estilos para anima√ß√£o de entrada do card */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in-up {
            animation: slideInUp 0.3s ease-out forwards;
        }

        /* Estilos para valida√ß√£o de formul√°rio */
        .input-error {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5); /* ring-red-500 */
        }
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }

        /* Estilos para o modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            position: fixed; /* Garante que ele cobre a viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Para centralizar o modal-content */
            align-items: center; /* Centraliza verticalmente */
            justify-content: center; /* Centraliza horizontalmente */
            z-index: 50; /* Garante que esteja acima de outros elementos */
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
            /* Ajustes para responsividade */
            width: 90%; /* Ocupa 90% da largura da tela */
            max-width: 768px; /* Limite m√°ximo para tablets e desktops */
            max-height: 90vh; /* Limita a altura para n√£o transbordar em telas pequenas */
            overflow-y: auto; /* Adiciona scroll se o conte√∫do for muito grande */
            margin: 1rem; /* Espa√ßamento nas bordas em telas pequenas */
        }

        /* Ajustes espec√≠ficos para a imagem dentro do modal */
        #detailsCover {
            width: 100%; /* Garante que a imagem preencha a largura dispon√≠vel */
            height: auto; /* Mant√©m a propor√ß√£o */
            max-height: 300px; /* Limita a altura da imagem no modal para n√£o ser excessiva */
            object-fit: contain; /* Garante que a imagem inteira seja vis√≠vel, sem cortar */
            margin: 0 auto; /* Centraliza a imagem se ela for menor que o cont√™iner */
            display: block; /* Remove espa√ßo extra abaixo da imagem */
        }

        /* Ajustes para o layout flex do modal em telas menores */
        .modal-content .flex-col.md\:flex-row {
            flex-direction: column; /* Por padr√£o, empilha em colunas */
        }

        @media (min-width: 768px) { /* md breakpoint */
            .modal-content .flex-col.md\:flex-row {
                flex-direction: row; /* Em telas m√©dias e maiores, layout em linha */
            }
            #detailsCover {
                max-height: none; /* Remove o limite de altura em telas maiores */
                object-fit: cover; /* Volta para cover em telas maiores se preferir */
            }
        }

        /* Estilos para a tela de login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #a7bfe8 0%, #6190e8 100%);
        }
        .login-card {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.5s ease-out;
        }
        .login-card h2 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #374151; /* gray-800 */
            margin-bottom: 1.5rem;
        }
        .login-card p {
            color: #6b7280; /* gray-600 */
            margin-bottom: 2rem;
        }
        .google-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #4285F4; /* Google Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
        }
        .google-btn:hover {
            background-color: #357ae8;
        }
        .google-btn img {
            margin-right: 0.75rem;
            width: 24px;
            height: 24px;
        }
        /* Bot√£o de tema */
        #themeToggle {
            background-color: #667eea; /* indigo-500 */
            color: white;
            border-radius: 9999px; /* full rounded */
            width: 48px; /* w-12 */
            height: 48px; /* h-12 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* text-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #themeToggle:hover {
            background-color: #5a67d8; /* indigo-600 */
            transform: scale(1.05);
        }
        #themeToggle:active {
            transform: scale(0.95);
        }

        /* Estilos para o menu mobile */
        #mobileMenu {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            max-height: 0;
        }
        #mobileMenu.open {
            max-height: 200px; /* Ajuste conforme o conte√∫do */
        }
        .dark #mobileMenu {
            background-color: #1a202c; /* gray-900 */
        }
        .dark #searchInputMobile {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .dark #searchInputMobile::placeholder {
            color: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Tela de Login (Inicialmente vis√≠vel) -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h2 class="text-4xl">üìö Minha Biblioteca</h2>
            <p class="text-lg">Acesse sua cole√ß√£o pessoal de livros.</p>
            <button id="googleSignInBtn" class="google-btn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/24px-Google_%22G%22_logo.svg.png" alt="Google logo">
                Entrar com Google
            </button>
            <div id="loginError" class="error-message mt-4 hidden"></div>
        </div>
    </div>

    <!-- Conte√∫do Principal da Biblioteca (Inicialmente oculto) -->
    <div id="mainContent" class="hidden">
        <header class="bg-indigo-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <!-- Logo/T√≠tulo Clic√°vel -->
                    <a href="#" onclick="event.preventDefault(); resetAndLoadBooks();" class="flex items-center space-x-2">
                        <h1 class="text-3xl font-bold">üìö Minha Biblioteca</h1>
                    </a>
                    
                    <!-- Barra de Pesquisa (movida para o header) -->
                    <div class="flex-grow mx-4 hidden md:block"> <!-- Oculta em telas pequenas, aparece em md+ -->
                        <input type="text" id="searchInputHeader" placeholder="Pesquisar livros..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" aria-label="Campo de pesquisa de livros">
                    </div>

                    <div class="flex items-center space-x-4">
                        <!-- Contagem de Livros (Exemplo) -->
                        <span id="bookStats" class="text-sm hidden lg:block"></span>

                        <!-- Menu Hamb√∫rguer para telas pequenas -->
                        <button id="menuToggle" class="md:hidden text-white text-2xl focus:outline-none" aria-label="Abrir menu de navega√ß√£o">
                            <i class="fas fa-bars"></i>
                        </button>

                        <!-- Op√ß√µes para telas maiores -->
                        <span id="userName" class="text-lg font-medium hidden md:block"></span>
                        <button id="addBookBtn" class="bg-white text-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-100 transition hidden md:block" aria-label="Adicionar novo livro">
                            <i class="fas fa-plus mr-2"></i>Adicionar Livro
                        </button>
                        <button id="signOutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition hidden md:block" aria-label="Sair da conta">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                        <button id="themeToggle" class="focus:outline-none" aria-label="Alternar modo claro/escuro">
                            <i class="fas fa-moon" id="themeIcon"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Menu responsivo (fora do header principal, mas controlado por ele) -->
            <div id="mobileMenu" class="hidden md:hidden bg-indigo-800 py-2 px-4">
                <input type="text" id="searchInputMobile" placeholder="Pesquisar livros..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 mb-2" aria-label="Campo de pesquisa de livros">
                <button id="addBookBtnMobile" class="w-full bg-white text-indigo-700 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-100 transition mb-2" aria-label="Adicionar novo livro">
                    <i class="fas fa-plus mr-2"></i>Adicionar Livro
                </button>
                <button id="signOutBtnMobile" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition" aria-label="Sair da conta">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <!-- Formul√°rio de Adi√ß√£o (Oculto Inicialmente) -->
            <div id="formContainer" class="form-container hidden rounded-xl p-6 mb-8">
                <h2 id="formTitle" class="text-2xl font-bold mb-6 text-gray-800">Adicionar Novo Livro</h2>
                <form id="bookForm" class="space-y-4">
                    <input type="hidden" id="bookId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2" for="cover">Capa do Livro (URL)</label>
                            <input type="text" id="cover" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Cole a URL da imagem da capa">
                            <p class="text-sm text-gray-500 mt-1">Ou deixe em branco para usar uma capa padr√£o</p>
                            <div id="coverError" class="error-message hidden">URL da imagem inv√°lida ou inacess√≠vel. Uma capa padr√£o ser√° usada.</div>
                            
                            <label class="block text-gray-700 mt-4 mb-2" for="coverUpload">Ou Carregar Imagem</label>
                            <div id="coverDropArea" class="w-full p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-500 hover:border-indigo-500 hover:text-indigo-700 transition cursor-pointer">
                                <input type="file" id="coverUpload" accept="image/*" class="hidden" aria-label="Carregar imagem de capa do livro">
                                <p><i class="fas fa-cloud-upload-alt mr-2"></i>Arraste e solte ou clique para carregar</p>
                            </div>

                            <div class="mt-4">
                                <div class="aspect-[2/3] overflow-hidden flex items-center justify-center bg-gray-100 rounded-lg border">
                                    <img id="coverPreview" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/7cbc6f4a-553c-4c39-990c-f4e353dd4e79.png" alt="Pr√©-visualiza√ß√£o da capa" class="w-full h-full object-cover">
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2" for="title">T√≠tulo do Livro*</label>
                                <input type="text" id="title" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Digite o t√≠tulo" aria-required="true">
                                <div id="titleError" class="error-message hidden">O t√≠tulo √© obrigat√≥rio.</div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2" for="author">Autor*</label>
                                <input type="text" id="author" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome do autor" aria-required="true">
                                <div id="authorError" class="error-message hidden">O autor √© obrigat√≥rio.</div>
                            </div>

                            <!-- NOVO CAMPO: Sinopse -->
                            <div>
                                <label class="block text-gray-700 mb-2" for="synopsis">Sinopse</label>
                                <textarea id="synopsis" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 h-32 resize-y" placeholder="Escreva uma breve sinopse do livro (opcional)"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">Sua Avalia√ß√£o</label>
                                <div class="star-rating" role="radiogroup" aria-label="Sua avalia√ß√£o do livro">
                                    <!-- CORRE√á√ÉO: Ordem invertida dos inputs e labels para o CSS funcionar corretamente -->
                                    <input id="star5" type="radio" name="rating" value="5" aria-label="5 estrelas" />
                                    <label for="star5"><i class="fas fa-star"></i></label>
                                    <input id="star4" type="radio" name="rating" value="4" aria-label="4 estrelas" />
                                    <label for="star4"><i class="fas fa-star"></i></label>
                                    <input id="star3" type="radio" name="rating" value="3" checked aria-label="3 estrelas" />
                                    <label for="star3"><i class="fas fa-star"></i></label>
                                    <input id="star2" type="radio" name="rating" value="2" aria-label="2 estrelas" />
                                    <label for="star2"><i class="fas fa-star"></i></label>
                                    <input id="star1" type="radio" name="rating" value="1" aria-label="1 estrela" />
                                    <label for="star1"><i class="fas fa-star"></i></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition" aria-label="Cancelar adi√ß√£o de livro">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" aria-label="Salvar livro">Salvar Livro</button>
                    </div>
                </form>
            </div>

            <!-- Controles de Filtro (mantidos aqui para organiza√ß√£o, mas a pesquisa principal est√° no header) -->
            <div class="mb-8 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4 ml-auto"> <!-- Ajustado para alinhar √† direita -->
                    <span class="text-gray-700">Ordenar por:</span>
                    <select id="sortFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" aria-label="Op√ß√µes de ordena√ß√£o de livros">
                        <option value="date">Mais recente</option>
                        <option value="date-desc">Mais antigo</option>
                        <option value="title">T√≠tulo (A-Z)</option>
                        <option value="title-desc">T√≠tulo (Z-A)</option>
                        <option value="rating">Avalia√ß√£o (Melhor primeiro)</option>
                        <option value="rating-desc">Avalia√ß√£o (Pior primeiro)</option>
                        <option value="favorite">Favoritos</option>
                    </select>
                </div>
            </div>

            <!-- Contagem de Livros (mantida aqui para detalhes, mas um resumo no header) -->
            <div id="bookCount" class="text-gray-600 mb-4 text-sm"></div>

            <!-- Biblioteca de Livros -->
            <div class="library-container">
                <div id="emptyState" class="text-center py-12">
                    <div class="max-w-md mx-auto">
                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/8fabbb5f-cbf2-4a88-a38b-7dbc507e2a14.png" alt="Ilustra√ß√£o de prateleira vazia com um bal√£o de pensamento mostrando livros" class="mx-auto mb-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Sua biblioteca est√° vazia</h3>
                        <p class="text-gray-600 mb-6">Comece adicionando seus primeiros livros para criar sua cole√ß√£o pessoal.</p>
                        <button id="emptyAddBookBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition" aria-label="Adicionar o primeiro livro">
                            <i class="fas fa-plus mr-2"></i>Adicionar Primeiro Livro
                        </button>
                    </div>
                </div>

                <div id="booksGrid" class="hidden grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Os livros ser√£o adicionados aqui via JavaScript -->
                </div>
                
                <!-- Controles de Pagina√ß√£o -->
                <div id="paginationControls" class="hidden mt-8 flex justify-center items-center space-x-4">
                    <button id="prevPage" class="px-4 py-2 bg-gray-200 rounded-md disabled:opacity-50 hover:bg-gray-300 transition" disabled aria-label="P√°gina anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo" class="font-medium" aria-live="polite">P√°gina 1</span>
                    <button id="nextPage" class="px-4 py-2 bg-gray-200 rounded-md disabled:opacity-50 hover:bg-gray-300 transition" aria-label="Pr√≥xima p√°gina">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div id="noResultsState" class="hidden text-center py-12">
                    <div class="max-w-md mx-auto">
                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/a0b1c2d3-e4f5-6789-abcd-ef1234567890.png" alt="Ilustra√ß√£o de lupa sem resultados" class="mx-auto mb-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Nenhum livro encontrado</h3>
                        <p id="noResultsMessage" class="text-gray-600 mb-6">Nenhum livro corresponde aos seus crit√©rios de pesquisa ou filtro.</p>
                        <button id="clearFiltersBtn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition" aria-label="Limpar pesquisa e filtros">
                            <i class="fas fa-redo mr-2"></i>Limpar Pesquisa e Filtros
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal de Confirma√ß√£o de Exclus√£o -->
        <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDescription">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm modal-content">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclus√£o</h3>
                <p id="modalDescription" class="text-gray-700 mb-6">Tem certeza que deseja remover "<span id="bookTitleToDelete" class="font-semibold"></span>" da sua biblioteca?</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancelDeleteBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition" aria-label="Cancelar exclus√£o">Cancelar</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" aria-label="Confirmar exclus√£o">Remover</button>
                </div>
            </div>
        </div>

        <!-- Modal de Detalhes do Livro -->
        <div id="bookDetailsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-overlay" role="dialog" aria-modal="true" aria-labelledby="detailsModalTitle">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-2xl mx-4 modal-content">
                <button id="closeDetailsModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl" aria-label="Fechar detalhes do livro">
                    <i class="fas fa-times-circle"></i>
                </button>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/3 flex-shrink-0">
                        <img id="detailsCover" src="" alt="Capa do livro" class="w-full h-auto object-cover rounded-lg shadow-md aspect-[2/3]" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/5567ae55-81ea-4b54-bd39-e98f853fbf08.png">
                    </div>
                    <div class="md:w-2/3">
                        <h3 id="detailsTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
                        <p id="detailsAuthor" class="text-xl text-gray-600 mb-4"></p>
                        <div class="flex items-center mb-4">
                            <div id="detailsRatingStars" class="flex mr-2"></div>
                            <span id="detailsRatingValue" class="text-lg font-semibold text-gray-700"></span>
                        </div>
                        <p id="detailsDateAdded" class="text-gray-500 text-sm mb-4"></p>
                        <!-- NOVO CAMPO: Sinopse no modal -->
                        <p id="detailsSynopsis" class="text-gray-700 text-base mb-4"></p>
                        <div class="mt-6 flex gap-3">
                            <!-- Bot√£o de Editar Removido -->
                            <button id="detailsDeleteBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-md" aria-label="Remover este livro da biblioteca">
                                <i class="fas fa-trash-alt mr-2"></i> Remover Livro
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        // NOVO: Importar Firestore
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvRjTq54g2pd2G5TizIZ7-7K1IxCPgVKE",
            authDomain: "biblioteca-65e05.firebaseapp.com",
            projectId: "biblioteca-65e05",
            storageBucket: "biblioteca-65e05.firebasestorage.app",
            messagingSenderId: "964553508507",
            appId: "1:964553508507:web:0f46f7681a5a470f1ea83e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app); // NOVO: Inicializa o Firestore

        // Elementos do DOM para login
        const loginScreen = document.getElementById('loginScreen');
        const mainContent = document.getElementById('mainContent');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userNameSpan = document.getElementById('userName');
        const loginError = document.getElementById('loginError');

        // Ouvinte de evento para o bot√£o de login do Google
        googleSignInBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
                // O onAuthStateChanged lidar√° com a exibi√ß√£o do conte√∫do principal
            } catch (error) {
                console.error("Erro ao fazer login com Google:", error);
                let errorMessage = "Erro ao fazer login. Tente novamente.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Login cancelado. A janela pop-up foi fechada.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Requisi√ß√£o de pop-up j√° em andamento ou bloqueada.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Erro de conex√£o. Verifique sua internet.";
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
                showNotification(errorMessage, 'error');
            }
        });

        // Ouvinte de evento para o bot√£o de logout
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // O onAuthStateChanged lidar√° com a exibi√ß√£o da tela de login
                showNotification('Voc√™ saiu da sua conta.', 'info');
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showNotification('Erro ao sair. Tente novamente.', 'error');
            }
        });

        // Observador de estado de autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usu√°rio logado
                loginScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userNameSpan.textContent = `Ol√°, ${user.displayName || user.email}!`;
                userNameSpan.classList.remove('hidden');
                loginError.classList.add('hidden'); // Esconde qualquer erro de login anterior
                loadBooks(); // Carrega os livros quando o usu√°rio est√° logado
            } else {
                // Usu√°rio deslogado
                loginScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
                userNameSpan.textContent = '';
                userNameSpan.classList.add('hidden');
                // Limpa a array de livros em mem√≥ria e renderiza a tela vazia
                books = []; 
                renderBooks([]); 
                emptyState.classList.remove('hidden'); 
                booksGrid.classList.add('hidden');
                noResultsState.classList.add('hidden');
                bookCount.textContent = 'Nenhum livro na biblioteca.';
                bookStatsSpan.textContent = 'Total: 0'; // Resetar estat√≠sticas no header
            }
        });

        // Armazenamento dos livros (agora preenchido pelo Firestore)
        let books = []; 
        // Vari√°veis de pagina√ß√£o
        const booksPerPage = 10;
        let currentPage = 1;
        let filteredBooks = [];
        let bookToDeleteId = null; // Vari√°vel para armazenar o ID do livro a ser exclu√≠do
        // let bookToEditId = null; // Vari√°vel para armazenar o ID do livro a ser editado - REMOVIDO

        // Elementos do DOM
        const addBookBtn = document.getElementById('addBookBtn');
        const emptyAddBookBtn = document.getElementById('emptyAddBookBtn');
        const formContainer = document.getElementById('formContainer');
        const formTitle = document.getElementById('formTitle');
        const cancelBtn = document.getElementById('cancelBtn');
        const bookForm = document.getElementById('bookForm');
        const emptyState = document.getElementById('emptyState');
        const booksGrid = document.getElementById('booksGrid');
        // const searchInput = document.getElementById('searchInput'); // Removido, agora h√° dois
        const searchInputHeader = document.getElementById('searchInputHeader'); // Novo
        const searchInputMobile = document.getElementById('searchInputMobile'); // Novo
        const sortFilter = document.getElementById('sortFilter');
        const coverInput = document.getElementById('cover');
        const coverUploadInput = document.getElementById('coverUpload');
        const coverDropArea = document.getElementById('coverDropArea');
        const coverPreview = document.getElementById('coverPreview');
        const coverError = document.getElementById('coverError');
        const titleInput = document.getElementById('title');
        const titleError = document.getElementById('titleError');
        const authorInput = document.getElementById('author');
        const authorError = document.getElementById('authorError');
        // NOVO ELEMENTO: Campo de sinopse
        const synopsisInput = document.getElementById('synopsis'); 
        const noResultsState = document.getElementById('noResultsState');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const bookCount = document.getElementById('bookCount');
        const bookStatsSpan = document.getElementById('bookStats'); // Novo para estat√≠sticas no header

        // Modal de Confirma√ß√£o de Exclus√£o
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const bookTitleToDeleteSpan = document.getElementById('bookTitleToDelete');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Modal de Detalhes do Livro
        const bookDetailsModal = document.getElementById('bookDetailsModal');
        const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
        const detailsCover = document.getElementById('detailsCover');
        const detailsTitle = document.getElementById('detailsTitle');
        const detailsAuthor = document.getElementById('detailsAuthor');
        const detailsRatingStars = document.getElementById('detailsRatingStars');
        const detailsRatingValue = document.getElementById('detailsRatingValue');
        const detailsDateAdded = document.getElementById('detailsDateAdded');
        // NOVO ELEMENTO: Sinopse no modal de detalhes
        const detailsSynopsis = document.getElementById('detailsSynopsis'); 
        // const detailsEditBtn = document.getElementById('detailsEditBtn'); // REMOVIDO
        const detailsDeleteBtn = document.getElementById('detailsDeleteBtn');

        // Bot√£o de tema
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');

        // Elementos do menu mobile
        const menuToggle = document.getElementById('menuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const addBookBtnMobile = document.getElementById('addBookBtnMobile');
        const signOutBtnMobile = document.getElementById('signOutBtnMobile');


        const DEFAULT_COVER_URL = "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/65c67a2c-4882-47de-a4ba-8f1cb4a4ad48.png";
        const FALLBACK_COVER_URL = "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/96e23b18-a244-46c7-a897-808615124e49.png"; // Fallback para cards

        // Ouvintes de Eventos Globais
        addBookBtn.addEventListener('click', () => showForm());
        emptyAddBookBtn.addEventListener('click', () => showForm());
        cancelBtn.addEventListener('click', hideForm);
        bookForm.addEventListener('submit', handleSubmit);
        
        // Ouvintes para as novas barras de pesquisa
        searchInputHeader.addEventListener('input', filterBooks);
        searchInputMobile.addEventListener('input', filterBooks);

        sortFilter.addEventListener('change', filterBooks);
        clearFiltersBtn.addEventListener('click', () => {
            searchInputHeader.value = ''; // Limpa ambos
            searchInputMobile.value = '';
            sortFilter.value = 'date'; // Volta para ordena√ß√£o padr√£o
            filterBooks();
            showNotification('Filtros e pesquisa limpos.', 'info');
        });

        // Ouvintes de Eventos do Formul√°rio de Capa
        coverInput.addEventListener('input', updateCoverPreview);
        coverPreview.addEventListener('error', () => {
            coverPreview.src = DEFAULT_COVER_URL;
            coverPreview.alt = "Pr√©-visualiza√ß√£o da capa padr√£o do livro";
            coverError.classList.remove('hidden');
        });
        coverPreview.addEventListener('load', () => {
            coverError.classList.add('hidden');
        });

        // Ouvintes de Eventos de Upload/Drag & Drop
        coverDropArea.addEventListener('click', () => coverUploadInput.click());
        coverUploadInput.addEventListener('change', handleCoverUpload);
        coverDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            coverDropArea.classList.add('border-indigo-500', 'text-indigo-700');
        });
        coverDropArea.addEventListener('dragleave', () => {
            coverDropArea.classList.remove('border-indigo-500', 'text-indigo-700');
        });
        coverDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            coverDropArea.classList.remove('border-indigo-500', 'text-indigo-700');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleCoverUpload({ target: { files: e.dataTransfer.files } });
            }
        });

        // Valida√ß√£o em tempo real
        titleInput.addEventListener('blur', validateTitle);
        titleInput.addEventListener('input', () => {
            if (titleInput.value.trim()) {
                titleInput.classList.remove('input-error');
                titleError.classList.add('hidden');
            }
        });
        authorInput.addEventListener('blur', validateAuthor);
        authorInput.addEventListener('input', () => {
            if (authorInput.value.trim()) {
                authorInput.classList.remove('input-error');
                authorError.classList.add('hidden');
            }
        });

        // Ouvintes de Eventos do Modal de Confirma√ß√£o
        cancelDeleteBtn.addEventListener('click', hideDeleteConfirmModal);
        confirmDeleteBtn.addEventListener('click', () => {
            if (bookToDeleteId) {
                deleteBookConfirmed(bookToDeleteId);
                bookToDeleteId = null; // Resetar
            }
        });

        // Ouvintes de Eventos do Modal de Detalhes
        closeDetailsModalBtn.addEventListener('click', hideBookDetailsModal);
        detailsDeleteBtn.addEventListener('click', async () => {
            const book = books.find(b => b.id === bookToDeleteId);
            if (confirm(`Tem certeza que deseja remover "${book.title}" da sua biblioteca?`)) {
                await deleteBookConfirmed(bookToDeleteId);
                hideBookDetailsModal();
            }
        });

        // L√≥gica do tema claro/escuro
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcon(isDarkMode);
        });

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
            }
            updateThemeIcon(savedTheme === 'dark');
        }

        function updateThemeIcon(isDarkMode) {
            if (isDarkMode) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        // Carregar tema ao iniciar
        loadTheme();

        // L√≥gica do menu mobile
        menuToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
            mobileMenu.classList.toggle('open');
        });

        // Ouvintes para os bot√µes do menu mobile
        addBookBtnMobile.addEventListener('click', () => {
            showForm();
            mobileMenu.classList.add('hidden'); // Fecha o menu ap√≥s a a√ß√£o
            mobileMenu.classList.remove('open');
        });
        signOutBtnMobile.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showNotification('Voc√™ saiu da sua conta.', 'info');
                mobileMenu.classList.add('hidden'); // Fecha o menu ap√≥s a a√ß√£o
                mobileMenu.classList.remove('open');
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showNotification('Erro ao sair. Tente novamente.', 'error');
            }
        });
        
        // Fun√ß√£o para resetar filtros e carregar livros (para o clique no logo)
        function resetAndLoadBooks() {
            searchInputHeader.value = '';
            searchInputMobile.value = '';
            sortFilter.value = 'date';
            loadBooks();
        }
        window.resetAndLoadBooks = resetAndLoadBooks; // Torna a fun√ß√£o global para o onclick no HTML
        
        // Fun√ß√µes
        function showForm(bookId = null) {
            formContainer.classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
            coverPreview.src = DEFAULT_COVER_URL;
            coverPreview.alt = "Pr√©-visualiza√ß√£o da capa";
            coverError.classList.add('hidden');
            titleInput.classList.remove('input-error');
            titleError.classList.add('hidden');
            authorInput.classList.remove('input-error');
            authorError.classList.add('hidden');
            document.getElementById('bookId').value = ''; // Limpa o ID para nova adi√ß√£o
            // bookToEditId = null; // Limpa o ID de edi√ß√£o - REMOVIDO

            if (bookId) { // Este bloco agora s√≥ ser√° acessado se a fun√ß√£o de edi√ß√£o for reintroduzida
                const book = books.find(b => b.id === bookId);
                if (book) {
                    formTitle.textContent = 'Editar Livro';
                    document.getElementById('bookId').value = book.id;
                    titleInput.value = book.title;
                    authorInput.value = book.author;
                    synopsisInput.value = book.synopsis || ''; 
                    coverInput.value = book.cover === DEFAULT_COVER_URL ? '' : book.cover;
                    coverPreview.src = book.cover;
                    coverPreview.alt = `Capa do livro ${book.title}`;
                    const ratingInput = document.querySelector(`input[name="rating"]:checked`);
                    if (ratingInput) {
                        ratingInput.checked = false; // Desmarca o atual
                    }
                    const newRatingInput = document.querySelector(`input[name="rating"][value="${book.rating}"]`);
                    if (newRatingInput) {
                        newRatingInput.checked = true;
                    }
                    // bookToEditId = book.id; // Armazena o ID para uso no modal de detalhes - REMOVIDO
                }
            } else {
                formTitle.textContent = 'Adicionar Novo Livro';
                bookForm.reset(); 
                document.querySelector('input[name="rating"][value="3"]').checked = true; // Padr√£o para 3 estrelas
                synopsisInput.value = ''; 
            }
            document.getElementById('title').focus();
        }
        
        function hideForm() {
            formContainer.classList.add('hidden');
            bookForm.reset();
            coverPreview.src = DEFAULT_COVER_URL; 
            coverPreview.alt = "Pr√©-visualiza√ß√£o da capa";
            titleInput.classList.remove('input-error');
            titleError.classList.add('hidden');
            authorInput.classList.remove('input-error');
            authorError.classList.add('hidden');
            coverError.classList.add('hidden');
            document.getElementById('bookId').value = ''; 
            // bookToEditId = null; // REMOVIDO
            synopsisInput.value = ''; 
        }
        
        function updateCoverPreview() {
            const url = coverInput.value.trim();
            if (url) {
                coverPreview.src = url;
                coverPreview.alt = "Pr√©-visualiza√ß√£o da capa do livro carregada pelo usu√°rio";
            } else {
                coverPreview.src = DEFAULT_COVER_URL;
                coverPreview.alt = "Pr√©-visualiza√ß√£o da capa padr√£o do livro";
                coverError.classList.add('hidden'); 
            }
        }

        function handleCoverUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    coverInput.value = e.target.result; 
                    coverPreview.src = e.target.result;
                    coverPreview.alt = `Pr√©-visualiza√ß√£o da capa carregada: ${file.name}`;
                    coverError.classList.add('hidden');
                };
                reader.onerror = () => {
                    coverPreview.src = DEFAULT_COVER_URL;
                    coverPreview.alt = "Erro ao carregar imagem. Capa padr√£o usada.";
                    coverError.classList.remove('hidden');
                    showNotification('Erro ao carregar a imagem do arquivo.', 'error');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function validateTitle() {
            if (!titleInput.value.trim()) {
                titleInput.classList.add('input-error');
                titleError.classList.remove('hidden');
                return false;
            }
            titleInput.classList.remove('input-error');
            titleError.classList.add('hidden');
            return true;
        }

        function validateAuthor() {
            if (!authorInput.value.trim()) {
                authorInput.classList.add('input-error');
                authorError.classList.remove('hidden');
                return false;
            }
            authorInput.classList.remove('input-error');
            authorError.classList.add('hidden');
            return true;
        }

        async function handleSubmit(e) { 
            e.preventDefault();
            
            const title = titleInput.value.trim();
            const author = authorInput.value.trim();
            const cover = coverInput.value.trim();
            const rating = document.querySelector('input[name="rating"]:checked').value;
            const synopsis = synopsisInput.value.trim();
            const bookId = document.getElementById('bookId').value; // Ainda existe para o caso de reintroduzir edi√ß√£o

            let isValid = validateTitle() && validateAuthor();

            if (!isValid) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showNotification('Voc√™ precisa estar logado para adicionar livros.', 'error');
                return;
            }

            try {
                // A l√≥gica de edi√ß√£o foi removida, ent√£o sempre adiciona um novo livro
                const newBook = {
                    title,
                    author,
                    cover: cover || DEFAULT_COVER_URL,
                    rating: parseInt(rating),
                    dateAdded: new Date().toISOString(),
                    isFavorite: false,
                    synopsis,
                    userId: user.uid 
                };
                
                const docRef = await addDoc(collection(db, `users/${user.uid}/books`), newBook); 
                newBook.id = docRef.id; 
                showNotification(`"${title}" foi adicionado √† sua biblioteca!`, 'success');
                
                hideForm();
                loadBooks(); 
            } catch (error) {
                console.error("Erro ao salvar livro:", error);
                showNotification('Erro ao salvar livro. Tente novamente.', 'error');
            }
        }
        
        async function loadBooks(newBookId = null) { 
            const user = auth.currentUser;
            if (!user) {
                books = []; 
                renderBooks([]); 
                emptyState.classList.remove('hidden');
                booksGrid.classList.add('hidden');
                noResultsState.classList.add('hidden');
                bookCount.textContent = 'Nenhum livro na biblioteca.';
                bookStatsSpan.textContent = 'Total: 0'; // Resetar estat√≠sticas no header
                return;
            }

            try {
                const booksCollectionRef = collection(db, `users/${user.uid}/books`);
                const q = query(booksCollectionRef, orderBy('dateAdded', 'desc')); 
                const querySnapshot = await getDocs(q);
                
                books = []; 
                querySnapshot.forEach((doc) => {
                    books.push({ id: doc.id, ...doc.data() });
                });

                if (books.length === 0) {
                    emptyState.classList.remove('hidden');
                    booksGrid.classList.add('hidden');
                    noResultsState.classList.add('hidden');
                    bookCount.textContent = 'Nenhum livro na biblioteca.';
                    bookStatsSpan.textContent = 'Total: 0'; // Atualizar estat√≠sticas no header
                    return;
                }
                
                emptyState.classList.add('hidden');
                booksGrid.classList.remove('hidden');
                noResultsState.classList.add('hidden');
                
                filterBooks(newBookId); 
            } catch (error) {
                console.error("Erro ao carregar livros:", error);
                showNotification('Erro ao carregar livros. Tente novamente.', 'error');
            }
        }
        
        async function filterBooks(newBookId = null) { 
            // Pega o valor da pesquisa da barra vis√≠vel (desktop ou mobile)
            const searchTerm = (searchInputHeader.value || searchInputMobile.value).toLowerCase();
            const sortBy = sortFilter.value;
            const user = auth.currentUser;

            if (!user) {
                filteredBooks = [];
                renderBooks([]);
                return;
            }

            let q;
            const booksCollectionRef = collection(db, `users/${user.uid}/books`);

            if (sortBy === 'favorite') {
                q = query(booksCollectionRef, where('isFavorite', '==', true));
            } else {
                let orderField = 'dateAdded';
                let orderDirection = 'desc';

                switch(sortBy) {
                    case 'title':
                        orderField = 'title';
                        orderDirection = 'asc';
                        break;
                    case 'title-desc':
                        orderField = 'title';
                        orderDirection = 'desc';
                        break;
                    case 'rating':
                        orderField = 'rating';
                        orderDirection = 'desc';
                        break;
                    case 'rating-desc':
                        orderField = 'rating';
                        orderDirection = 'asc';
                        break;
                    case 'date':
                        orderField = 'dateAdded';
                        orderDirection = 'desc';
                        break;
                    case 'date-desc':
                        orderField = 'dateAdded';
                        orderDirection = 'asc';
                        break;
                }
                q = query(booksCollectionRef, orderBy(orderField, orderDirection));
            }

            try {
                const querySnapshot = await getDocs(q);
                let tempBooks = [];
                querySnapshot.forEach((doc) => {
                    tempBooks.push({ id: doc.id, ...doc.data() });
                });

                filteredBooks = tempBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) || 
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.synopsis && book.synopsis.toLowerCase().includes(searchTerm))
                );

                currentPage = 1;
                renderBooks(filteredBooks, searchTerm, newBookId);

            } catch (error) {
                console.error("Erro ao filtrar livros:", error);
                showNotification('Erro ao filtrar livros. Tente novamente.', 'error');
            }
        }
        
        function renderBooks(booksToRender, searchTerm = '', newBookId = null) {
            booksGrid.innerHTML = '';
            
            // Atualiza a contagem de livros no rodap√©
            bookCount.textContent = `Exibindo ${booksToRender.length} de ${books.length} livros.`;
            if (searchTerm || sortFilter.value === 'favorite') {
                bookCount.textContent = `Exibindo ${booksToRender.length} livros (filtrados de ${books.length}).`;
            } else {
                bookCount.textContent = `Total de livros: ${books.length}.`;
            }

            // Atualiza as estat√≠sticas no header
            bookStatsSpan.textContent = `Total: ${books.length}`;


            const paginationControls = document.getElementById('paginationControls');
            if (booksToRender.length > booksPerPage) {
                paginationControls.classList.remove('hidden');
                updatePaginationControls(booksToRender.length);
            } else {
                paginationControls.classList.add('hidden');
            }
            
            if (booksToRender.length === 0) {
                booksGrid.classList.add('hidden');
                noResultsState.classList.remove('hidden');
                if (searchTerm || sortFilter.value === 'favorite') {
                    noResultsMessage.textContent = `Nenhum livro encontrado para "${searchTerm}" com os filtros atuais.`;
                } else {
                    noResultsMessage.textContent = `Nenhum livro corresponde aos seus crit√©rios de filtro.`;
                }
                emptyState.classList.add('hidden');
                return;
            }
            
            booksGrid.classList.remove('hidden');
            noResultsState.classList.add('hidden');
            emptyState.classList.add('hidden');
            
            const booksToDisplay = getPaginatedBooks(booksToRender);
            
            booksToDisplay.forEach(book => {
                const stars = renderStars(book.rating);
                const isFavorite = book.isFavorite ? 'text-red-500' : 'text-gray-400';
                
                const bookElement = document.createElement('div');
                bookElement.id = `book-${book.id}`;
                bookElement.className = `book-card bg-white rounded-xl overflow-hidden relative hover:shadow-md transition-all flex flex-col cursor-pointer ${newBookId === book.id ? 'animate-slide-in-up' : ''}`;
                bookElement.setAttribute('tabindex', '0'); 
                bookElement.setAttribute('role', 'button'); 
                bookElement.setAttribute('aria-label', `Ver detalhes do livro ${book.title} por ${book.author}`);

                bookElement.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="relative aspect-[2/3]">
                            <div class="h-full w-full overflow-hidden flex items-center justify-center bg-gray-100">
                                <img src="${book.cover}" alt="Capa do livro ${book.title} por ${book.author}" class="w-full h-full object-cover" 
                                     onerror="this.src='${FALLBACK_COVER_URL}'; this.closest('.relative').querySelector('.cover-warning-icon').classList.remove('hidden');">
                            </div>
                            <div class="absolute top-0 right-0 bg-indigo-600 text-white px-3 py-1 rounded-bl-lg font-semibold">${book.rating}.0</div>
                            <div class="absolute top-2 left-10 text-yellow-500 cover-warning-icon ${book.cover === DEFAULT_COVER_URL ? '' : 'hidden'}" title="Capa padr√£o usada (URL original inv√°lida)">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="p-4 flex-grow">
                            <h3 class="font-bold text-lg text-gray-800 mb-1 line-clamp-2">${book.title}</h3>
                            <p class="text-gray-600 mb-3">${book.author}</p>
                            <div class="flex items-center mt-auto">
                                <div class="relative flex items-center">
                                    <div class="flex">
                                        ${stars}
                                    </div>
                                    <div class="ml-2 text-sm font-semibold text-gray-700">${book.rating}.0</div>
                                </div>
                            </div>
                        </div>
                        <div class="absolute top-2 left-2 flex gap-1">
                            <button onclick="event.stopPropagation(); toggleFavorite('${book.id}')" class="w-8 h-8 bg-white bg-opacity-80 rounded-full flex items-center justify-center ${isFavorite} hover:bg-red-100 transition" aria-label="${book.isFavorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                <i class="${book.isFavorite ? 'fas' : 'far'} fa-heart"></i>
                            </button>
                            <button onclick="event.stopPropagation(); showDeleteConfirmModal('${book.id}')" class="w-8 h-8 bg-white bg-opacity-80 rounded-full flex items-center justify-center text-red-500 hover:bg-red-100 transition" aria-label="Remover livro ${book.title}">
                                <i class="fas fa-times"></i>
                            </button>
                            <!-- Bot√£o de Editar Removido do card -->
                        </div>
                    </div>
                `;
                
                bookElement.addEventListener('click', () => showBookDetailsModal(book.id));
                booksGrid.appendChild(bookElement);
            });
        }
        
        function getPaginatedBooks(booksToRender) {
            const startIndex = (currentPage - 1) * booksPerPage;
            return booksToRender.slice(startIndex, startIndex + booksPerPage);
        }

        function updatePaginationControls(totalBooks) {
            const totalPages = Math.ceil(totalBooks / booksPerPage);
            document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
            
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            prevBtn.onclick = null;
            nextBtn.onclick = null;

            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderBooks(filteredBooks);
                    window.scrollTo({ top: 0, behavior: 'smooth' }); 
                }
            };
            
            nextBtn.onclick = () => {
                if (currentPage * booksPerPage < filteredBooks.length) {
                    currentPage++;
                    renderBooks(filteredBooks);
                    window.scrollTo({ top: 0, behavior: 'smooth' }); 
                }
            };
        }

        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `
                    <span class="text-${i <= rating ? 'yellow-400' : 'gray-300'}">
                        <i class="fas fa-star"></i>
                    </span>
                `;
            }
            return stars;
        }

        // Fun√ß√µes de Favoritos
        window.toggleFavorite = async function(id) { 
            const user = auth.currentUser;
            if (!user) {
                showNotification('Voc√™ precisa estar logado para marcar favoritos.', 'error');
                return;
            }

            const bookIndex = books.findIndex(book => book.id === id);
            if (bookIndex > -1) {
                const currentFavoriteStatus = books[bookIndex].isFavorite;
                const bookRef = doc(db, `users/${user.uid}/books`, id);

                try {
                    await updateDoc(bookRef, {
                        isFavorite: !currentFavoriteStatus
                    });
                    books[bookIndex].isFavorite = !currentFavoriteStatus; 
                    filterBooks(); 
                    showNotification(
                        !currentFavoriteStatus ? `"${books[bookIndex].title}" adicionado aos favoritos!` : `"${books[bookIndex].title}" removido dos favoritos.`,
                        'info'
                    );
                } catch (error) {
                    console.error("Erro ao alternar favorito:", error);
                    showNotification('Erro ao atualizar favorito. Tente novamente.', 'error');
                }
            }
        }
        
        // Fun√ß√µes do Modal de Confirma√ß√£o de Exclus√£o
        window.showDeleteConfirmModal = function(id) {
            bookToDeleteId = id;
            const book = books.find(b => b.id === id);
            if (book) {
                bookTitleToDeleteSpan.textContent = book.title;
                deleteConfirmModal.classList.remove('hidden');
            }
        }

        function hideDeleteConfirmModal() {
            deleteConfirmModal.classList.add('hidden');
            bookToDeleteId = null;
        }

        async function deleteBookConfirmed(id) { 
            hideDeleteConfirmModal();
            const user = auth.currentUser;
            if (!user) {
                showNotification('Voc√™ precisa estar logado para remover livros.', 'error');
                return;
            }

            const bookElement = document.getElementById(`book-${id}`);
            const deletedBookTitle = books.find(book => book.id === id)?.title;

            if (bookElement) {
                bookElement.classList.add('animate-shrink-fade');
                bookElement.addEventListener('animationend', async () => { 
                    try {
                        await deleteDoc(doc(db, `users/${user.uid}/books`, id)); 
                        books = books.filter(book => book.id !== id); 
                        loadBooks(); 
                        showNotification(`"${deletedBookTitle}" removido com sucesso!`, 'success');
                    } catch (error) {
                        console.error("Erro ao excluir livro:", error);
                        showNotification('Erro ao remover livro. Tente novamente.', 'error');
                    }
                });
            } else {
                try {
                    await deleteDoc(doc(db, `users/${user.uid}/books`, id)); 
                    books = books.filter(book => book.id !== id); 
                    loadBooks(); 
                    showNotification(`"${deletedBookTitle}" removido com sucesso!`, 'success');
                } catch (error) {
                    console.error("Erro ao excluir livro:", error);
                    showNotification('Erro ao remover livro. Tente novamente.', 'error');
                }
            }
        }

        // Fun√ß√µes do Modal de Detalhes do Livro
        window.showBookDetailsModal = function(id) {
            const book = books.find(b => b.id === id);
            if (book) {
                bookToDeleteId = book.id; // Armazena o ID para o bot√£o de exclus√£o no modal de detalhes
                detailsCover.src = book.cover;
                detailsCover.alt = `Capa do livro ${book.title}`;
                detailsTitle.textContent = book.title;
                detailsAuthor.textContent = book.author;
                detailsRatingStars.innerHTML = renderStars(book.rating);
                detailsRatingValue.textContent = `${book.rating}.0`;
                detailsDateAdded.textContent = `Adicionado em: ${new Date(book.dateAdded).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}`;
                detailsSynopsis.textContent = book.synopsis || 'Nenhuma sinopse dispon√≠vel para este livro.';
                
                bookDetailsModal.classList.remove('hidden');
            }
        }

        function hideBookDetailsModal() {
            bookDetailsModal.classList.add('hidden');
            bookToDeleteId = null; // Limpa o ID ao fechar o modal
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            let bgColor, iconClass;

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    iconClass = 'fas fa-times-circle';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-500';
                    iconClass = 'fas fa-info-circle';
                    break;
            }

            notification.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center animate-fade-in z-50`;
            notification.innerHTML = `
                <i class="${iconClass} mr-2"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('animate-fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
